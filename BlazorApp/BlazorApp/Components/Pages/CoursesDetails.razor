@page "/course/{id:string}"
@using System.Text.Json.Serialization
@using System.Text.Json
@attribute [StreamRendering]

@if (course == null)
{
    <p><em>Loading...</em></p>
}
else
{
    <section class="singel-courses">
        <section class="singel-courses-box">
            <img src="images/courses/@course.ImageName" alt="Computer Image">

            <div class="container">
                <div class="home-course">
                    <a class="home-and-course">
                        <i class="fa-light fa-house"></i>
                        <p class="home">Home</p>
                    </a>

                    <i class="fa-light fa-angles-right"></i>
                    <p class="courses">Courses</p>

                    <i class="fa-light fa-angles-right"></i>
                    <p class="courses">@course.Title</p>
                </div>

                <div class="content">
                    <div class="label">
                        <div class="bestseller">
                            <p>Best Seller</p>
                        </div>
                        <div class="digital">
                            <p>Digital</p>
                        </div>
                    </div>

                    <h1 class="h1">@course.Title</h1>
                    <p class="text-xl">Egestas feugiat lorem eu neque suspendisse ullamcorper scelerisque aliquam mauris.</p>

                    <div class="rating">
                        <div class="star">
                            <i class="fa-solid fa-star"></i>
                            <i class="fa-solid fa-star"></i>
                            <i class="fa-solid fa-star"></i>
                            <i class="fa-solid fa-star"></i>
                            <i class="fa-regular fa-star"></i>
                        </div>

                        <div class="reviews">
                            <p>(1.2K reviews)</p>
                            <div></div>
                        </div>

                        <div class="likes">
                            <i class="fa-sharp fa-light fa-thumbs-up"></i>
                            <p>5K likes</p>
                            <div>.</div>
                        </div>

                        <div class="hours">
                            <i class="fa-regular fa-clock"></i>
                            <p>220 hours</p>
                        </div>
                    </div>

                    <div class="auther">
                        <div class="author-image">
                            <img class="created-img" src="images/author-image.png" alt="Author Image">
                        </div>
                        <div class="author-info">
                            <p class="created">Created by</p>
                            <p class="author-name">@course.Author</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section class="course-box-description container">
            <div class="box-one">
                <div class="course-description"></div>
                <h2>Course Description</h2>
                <p>Suspendisse natoque sagittis, consequat turpis. Sed tristique tellus morbi magna. At vel senectus accumsan, arcu mattis id tempor. Tellus sagittis, euismod porttitor sed tortor est id. Feugiat velit velit, tortor ut. Ut libero cursus nibh lorem urna amet tristique leo. Viverra lorem arcu nam nunc at ipsum quam. A proin id sagittis dignissim mauris condimentum ornare. Tempus mauris sed dictum ultrices.</p>
                <h3>What you'll learn</h3>
                <div class="content-box">
                    <div class="box">
                        <i class="fa-light fa-circle-check"></i>
                        <p>Sed lectus donec amet eu turpis interdum.</p>
                    </div>
                    <div class="box">
                        <i class="fa-light fa-circle-check"></i>
                        <p>Nulla at consectetur vitae dignissim porttitor.</p>
                    </div>
                    <div class="box">
                        <i class="fa-light fa-circle-check"></i>
                        <p>Phasellus id vitae dui aliquet mi.</p>
                    </div>
                    <div class="box">
                        <i class="fa-light fa-circle-check"></i>
                        <p>Integer cursus vitae, odio feugiat iaculis aliquet diam, et purus.</p>
                    </div>
                    <div class="box">
                        <i class="fa-light fa-circle-check"></i>
                        <p>In aenean dolor diam tortor orci eu.</p>
                    </div>
                </div>
            </div>

            <div class="box-two">
                <h3>This course includes:</h3>
                <div class="content-box">
                    <div class="box">
                        <i class="fa-regular fa-tv"></i>
                        <p>148 hours on-demand video</p>
                    </div>
                    <div class="box">
                        <i class="fa-thin fa-newspaper"></i>
                        <p>18 articles</p>
                    </div>
                    <div class="box">
                        <i class="fa-light fa-download"></i>
                        <p>25 downloadable resources</p>
                    </div>
                    <div class="box">
                        <i class="fa-regular fa-infinity"></i>
                        <p>Full lifetime access</p>
                    </div>
                    <div class="box">
                        <i class="fa-light fa-wreath-laurel"></i>
                        <p>Certificate of completion</p>
                    </div>
                </div>

                <div class="price">
                    <h1>$@course.Price</h1>
                    <h3 class="discounted-price-line-through">$@course.DiscountPrice</h3>
                </div>
                <SingleCourseButton />
            </div>
        </section>

        <section class="programdetails">
            <div class="container">
                <div class="box-three">
                    <h2>Program Details</h2>

                    <div class="line-vertical"></div>

                    <div class="content">
                        <div class="circle-gray">
                            <div class="circle-wite">
                                <p>1</p>
                            </div>
                        </div>
                        <div class="content-text">
                            <h3>Introduction. Getting started</h3>
                            <p>Nulla faucibus mauris pellentesque blandit faucibus non. Sit ut et at suspendisse gravida hendrerit tempus placerat.</p>
                        </div>
                    </div>

                    <div class="content">
                        <div class="circle-gray">
                            <div class="circle-wite">
                                <p>2</p>
                            </div>
                        </div>
                        <div class="content-text">
                            <h3>The ultimate HTML developer: advanced HTML</h3>
                            <p>Lobortis diam elit id nibh ultrices sed penatibus donec. Nibh iaculis eu sit cras ultricies. Nam eu eget etiam egestas donec scelerisque ut ac enim. Vitae ac nisl, enim nec accumsan vitae est.</p>
                        </div>
                    </div>

                    <div class="content">
                        <div class="circle-gray">
                            <div class="circle-wite">
                                <p>3</p>
                            </div>
                        </div>
                        <div class="content-text">
                            <h3>CSS & CSS3: basic</h3>
                            <p>Duis euismod enim, facilisis risus tellus pharetra lectus diam neque. Nec ultrices mi faucibus est. Magna ullamcorper potenti elementum ultricies auctor nec volutpat augue.</p>
                        </div>
                    </div>

                    <div class="content">
                        <div class="circle-gray">
                            <div class="circle-wite">
                                <p>4</p>
                            </div>
                        </div>
                        <div class="content-text">
                            <h3>JavaScript basics for beginners</h3>
                            <p>Morbi porttitor risus imperdiet a, nisl mattis. Amet, faucibus eget in platea vitae, velit, erat eget velit. At lacus ut proin erat.</p>
                        </div>
                    </div>

                    <div class="content">
                        <div class="circle-gray">
                            <div class="circle-wite">
                                <p>5</p>
                            </div>
                        </div>
                        <div class="content-text">
                            <h3>Understanding APIs</h3>
                            <p>Risus morbi euismod in congue scelerisque fusce pellentesque diam consequat. Nisi mauris nibh sed est morbi amet arcu urna. Malesuada feugiat quisque consectetur elementum diam vitae. Dictumst facilisis odio eu quis maecenas risus odio fames bibendum.</p>
                        </div>
                    </div>

                    <div class="content">
                        <div class="circle-gray">
                            <div class="circle-wite">
                                <p>6</p>
                            </div>
                        </div>
                        <div class="content-text">
                            <h3>Deploying your project from scratch</h3>
                            <p>Elit habitasse tempor, egestas nibh sit est vitae mauris scelerisque. Egestas feugiat lorem eu neque suspendisse ullamcorper scelerisque aliquam mauris.</p>
                        </div>
                    </div>

                    <div class="content">
                        <div class="circle-gray">
                            <div class="circle-wite">
                                <p>7</p>
                            </div>
                        </div>
                        <div class="content-text">
                            <h3>Working with databases</h3>
                            <p>Ut volutpat est sed lorem feugiat id scelerisque feugiat. Nibh elit, sed et pretium, pharetra nisl. Mauris ut mauris vel tortor, sed elementum.</p>
                        </div>
                    </div>

                    <div class="content">
                        <div class="circle-gray">
                            <div class="circle-wite">
                                <p>8</p>
                            </div>
                        </div>
                        <div class="content-text">
                            <h3>Building your first project</h3>
                            <p>Arcu purus luctus nisi volutpat tincidunt. Aliquet dui ut magna ut faucibus. Nam sit interdum malesuada proin habitant. Interdum cras quam tristique egestas feugiat adipiscing.</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </section>
}

@code {
    [Parameter]
    public string Id { get; set; } = null!;

    private CourseModel? course;

    protected override async Task OnInitializedAsync()
    {
        var query = new GraphQLQuery
            {
                query = $@"{{
        getCourseById(id: ""{Id}"") {{
            id
            title
            price
            discountPrice
            hours
            isBestseller
            likesInNumbers
            likesInProcent
            author
            imageName
            categoryId
            category {{
                id
                categoryName
            }}
        }}
    }}"
            };

        var response = await Http.PostAsJsonAsync("https://courseprovider-silicon-et.azurewebsites.net/api/graphql?code=HwR4hOUedeBAkP2RuBebzjkPFIezqH_ZfFQZ85Vbr9pLAzFuGFDHGg%3D%3D", query);

        if (response.IsSuccessStatusCode)
        {
            var result = await response.Content.ReadFromJsonAsync<DynamicGraphQLResponse>();
            var courseData = result?.Data.GetProperty("getCourseById");

            if (courseData.HasValue)
            {
                course = new CourseModel
                {
                    Id = courseData.Value.GetProperty("id").GetString()!,
                    Title = courseData.Value.GetProperty("title").GetString()!,
                    Price = courseData.Value.GetProperty("price").GetDecimal(),
                    DiscountPrice = courseData.Value.GetProperty("discountPrice").GetDecimal(),
                    Hours = courseData.Value.GetProperty("hours").GetDecimal(),
                    IsBestseller = courseData.Value.GetProperty("isBestseller").GetBoolean(),
                    LikesInNumbers = courseData.Value.GetProperty("likesInNumbers").GetDecimal(),
                    LikesInProcent = courseData.Value.GetProperty("likesInProcent").GetDecimal(),
                    Author = courseData.Value.GetProperty("author").GetString(),
                    ImageName = courseData.Value.GetProperty("imageName").GetString(),
                    Category = new CourseModel.CategoryModel
                    {
                        Id = courseData.Value.GetProperty("category").GetProperty("id").GetString()!,
                        CategoryName = courseData.Value.GetProperty("category").GetProperty("categoryName").GetString()!
                    }
                };
            }
        }
    }


    public class StringRouteConstraint : IRouteConstraint
    {
        public bool Match(HttpContext httpContext, IRouter route, string routeKey, RouteValueDictionary values, RouteDirection routeDirection)
        {
            object value;
            if (values.TryGetValue(routeKey, out value) && value is string)
            {
                // Validate the value of the route parameter here and return true if it is valid
                return true;
            }

            return false;
        }
    }

    public class CourseModel
    {
        public string Id { get; set; } = null!;
        public string Title { get; set; } = null!;
        public decimal Price { get; set; }
        public decimal DiscountPrice { get; set; }
        public decimal Hours { get; set; }
        public bool IsBestseller { get; set; }
        public decimal LikesInNumbers { get; set; }
        public decimal LikesInProcent { get; set; }
        public string? Author { get; set; }
        public string? ImageName { get; set; }

        public string? CategoryId { get; set; }
        public virtual CategoryModel? Category { get; set; }

        public class CategoryModel
        {
            public string Id { get; set; } = null!;
            public string CategoryName { get; set; } = null!;
        }
    }

    public class GraphQLQuery
    {
        public string query { get; set; } = null!;
    }

    public class DynamicGraphQLResponse
    {
        [JsonPropertyName("data")]
        public JsonElement Data { get; set; }
    }
}
